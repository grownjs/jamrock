<script>
  import {
    session, put_session, query_params,
  } from 'jamrock/conn';

  import { File, exists, unlink } from 'jamrock/utilities';

  import Failure from 'jamrock/components/failure';

  export let value = session.name || 'world';
  export let blob = session.image;

  // FIXME: avoid file-overrides if blob is not given or empty...
  if (Array.isArray(value)) value = value.pop();
  if (!(blob && blob.size)) blob = session.image;

  let error;
  let data;
  if (blob && blob.type.includes('image/')) {
    try {
      if (blob instanceof File) {
        blob.save('public/files');
      } else {
        blob = new File(blob);
      }
      data = blob.toDataURI();
    } catch (e) {
      error = e;
    }
  }

  function clear() {
    if (blob && exists(blob.path)) {
      unlink(blob.path);
    }
    blob = null;
    data = null;
  }

  $: fixed = value.toUpperCase();
  $: put_session('name', value);
  $: put_session('image', blob);
</script>

<style scoped>
  img { max-width: 100%; }
  pre { overflow: auto; }
</style>

<fragment id="root">
  <form @patch enctype="multipart/form-data">
    <p>Hello, {fixed}.</p>

    <select bind:value>
      <option value=""></option>
      <option>A</option>
      <option>B</option>
      <option>C</option>
    </select>

    <input bind:value />

    <hr />

    <input type="file" accept="image/*" bind:value={blob} />

    <noscript>
      <button hidden>Save</button>
    </noscript>

    <button disabled={!blob} on:click={clear}>Remove</button>
  </form>

  <img src={data} />

  <pre>{blob}</pre>

  <hr />

  <p>
    <a @url="?check={Math.random()}" href="/binds">Link</a>: {query_params}
  </p>

  <Failure from={error} />
</fragment>
