<script>
  import { reply } from 'jamrock/conn';
  import { readable } from 'jamrock/store';
  import { useFragment, onConnect } from 'jamrock/hooks';

  let status = 'running';
  let inc = 0;
  let t;
  const timer = readable(inc, set => {
    const interval = setInterval(() => {
      set(++inc);
    }, 1000);

    return () => clearInterval(interval);
  });

  // FIXME: kinda working... reflex about the dsl/api: it does not look bad at all, just not enough stable?
  const $frag = useFragment('timer');

  $: reply('info', { status });

  function pause() {
    clearTimeout(t);
    status = 'paused';
    $frag.pause();
  }

  function toggle() {
    if ($frag.idle) {
      status = 'running';
      // FIXME: this is very flaky... not stable and such!
      // i noticed that... if we click so soon, it feels wrong, but if you wait, say, 2s? it works!
      // also, using a :else branch we can deal with no-initiall data... by rendering a fallback instead
      reply('timer', { timer: inc - 1 });
      setTimeout(() => $frag.resume(), 1000);
      t = setTimeout(pause, 3000);
    } else {
      pause();
    }
  }

  onConnect(() => {
    t = setTimeout(pause, 3000);
    return () => clearTimeout(t);
  });

  export default {
    pause,
    toggle,
  };
</script>

<div>
  <!--

  FIXME: interesting... this MUST be set to zero in order to allow updates... but,
  if set... then, the initial value is not rendered... unless we set it as 1, but then,
  further updates got broken... we need a way to tell the compiler: hey, once running, use the limit?

  actually, after resume, the limit is causing issues... why not disable it?

  TODO: ...this limit, should work only for the first-renders... not defer calls!

  -->
  <fragment id="timer" limit="0">
    <em>{#each timer}{this}{:else}{inc}{/each}</em>
  </fragment>
</div>

<div>
  <fragment id="info">
    <button disabled="{status === 'paused'}" on:click @trigger="pause">⏸︎</button>
    <button disabled="{status !== 'paused'}" on:click @trigger="toggle">⏯︎</button>
    <span>{status}</span>
  </fragment>
</div>
