<script>
  import {
    redirect, routes, body_params, query_params, put_session,
  } from 'jamrock/conn';

  import { Link, Failure } from 'jamrock/components';

  import { Session, User } from '~/shared/database:models';
  import { isLogged } from '~/shared/stores';

  let error = null;
  let auth = null;

  if (query_params.token) {
    const session = await Session.findOne({ where: { token: query_params.token } });
    const user = await User.findOne({ where: { email: session.email } });

    auth = { token: query_params.token, user, session };
  }

  $: if (auth) {
    put_session({
      auth: auth.token,
      user: {
        currentInfo: auth.user.getRaw(),
        expirationDate: auth.session.expirationDate,
      },
    });
    redirect(routes.login_page());
  }

  export default {
    as: 'login_page',
    async POST() {
      const { email, password } = body_params;
      const { user, session } = await Session.verifyAndCreate(email, password);

      auth = { token: session.token, user, session };
    },
    onError(e) {
      error = e;
    },
  };
</script>

<head>
  <title>Log in</title>
</head>

{#if isLogged}
  <h3>Glad you're back!</h3>
  <form action="/logout?_method=DELETE" method="POST" @async>
    <button type="submit">Logout</button>
  </form>
{:else}
  <h3>Please log in&hellip;</h3>
  <form method="post" @async="select">
    <p>
      <label>
        E-mail:
        <input type="email" name="email" value={body_params.email} autocomplete="current-email" autofocus required />
      </label>
    </p>
    <p>
      <label>
        Password:
        <input type="password" name="password" autocomplete="current-password" required />
      </label>
    </p>
    <Failure from="{error}" />
    <button type="submit">Login</button> or <Link to="/new">create your account</Link>.
  </form>
{/if}
